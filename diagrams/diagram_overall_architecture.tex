\begin{figure}[t]
\centering
\begin{tikzpicture}[
    node distance=0.4cm and 0.8cm,
    % Base styles
    basebox/.style={minimum width=1.6cm, minimum height=0.6cm, align=center, font=\footnotesize},
    % Parallelogram for inputs/specs (slanted)
    inputbox/.style={basebox, draw, fill=blue!10,
        trapezium, trapezium left angle=70, trapezium right angle=110},
    specbox/.style={basebox, draw, fill=purple!10,
        trapezium, trapezium left angle=70, trapezium right angle=110},
    % Rectangle for processes
    processbox/.style={basebox, rectangle, draw, fill=orange!15},
    % Rounded rectangle for outputs
    outputbox/.style={basebox, rectangle, rounded corners=6pt, draw, fill=green!10},
    % Final output: double border
    finalbox/.style={basebox, rectangle, rounded corners=6pt, draw, fill=green!25, line width=1.5pt},
    % Arrow style
    arrow/.style={->, >=stealth, thick},
    % Legend styles
    legendpara/.style={draw, fill=#1, trapezium, trapezium left angle=70, trapezium right angle=110,
        minimum width=0.5cm, minimum height=0.25cm, inner sep=1pt},
    legendrect/.style={draw, fill=#1, rectangle, minimum width=0.5cm, minimum height=0.25cm},
    legendround/.style={draw, fill=#1, rectangle, rounded corners=4pt, minimum width=0.5cm, minimum height=0.25cm},
    legendfinal/.style={draw, fill=#1, rectangle, rounded corners=4pt, minimum width=0.5cm, minimum height=0.25cm, line width=1.2pt},
]

% Row 1: Input and Processing pipeline
\node[inputbox] (solidity) {Solidity\\Source};
\node[processbox, right=0.8cm of solidity] (static) {Static\\Analysis};
\node[processbox, right=of static] (stateinit) {State\\Init};
\node[processbox, right=of stateinit] (fuzzer) {Goal Violation\\Search};
\node[outputbox, right=of fuzzer] (violations) {Goal\\Violations};

% Specs below their corresponding processes
\node[specbox, below=0.6cm of static] (goalspec) {Role/Goal\\Spec};
\node[specbox, below=0.6cm of stateinit] (statespec) {State\\Spec};

% Arrows: inputs to static analysis
\draw[arrow] (solidity) -- (static);
\draw[arrow] (goalspec) -- (static);  % now vertical, spec below process

% Container: Goal-Directed Fuzzing (encapsulates State Init and Goal Violation Search)
\node[draw, dashed, rounded corners=6pt, inner sep=0.2cm, fit=(stateinit)(fuzzer),
      label={[font=\footnotesize\itshape, anchor=south]above:Goal-Directed Fuzzing}] (gdfcontainer) {};

% Arrow: state spec to state initialization
\draw[arrow] (statespec) -- (stateinit);

% Arrows: main pipeline flow
\draw[arrow] (static) -- (stateinit);
\draw[arrow] (stateinit) -- (fuzzer);
\draw[arrow] (fuzzer) -- (violations);

% Legend - below diagram, centered
\node[anchor=north, yshift=-0.6cm] at (current bounding box.south) {
    \footnotesize
    \begin{tabular}{@{}c@{\hspace{0.1cm}}l@{\hspace{0.4cm}}c@{\hspace{0.1cm}}l@{\hspace{0.4cm}}c@{\hspace{0.1cm}}l@{\hspace{0.4cm}}c@{\hspace{0.1cm}}l@{}}
        \tikz\node[legendpara=blue!10] {}; & Input &
        \tikz\node[legendpara=purple!10] {}; & Specification &
        \tikz\node[legendrect, fill=orange!15] {}; & Processing &
        \tikz\node[legendround, fill=green!10] {}; & Output
    \end{tabular}
};

\end{tikzpicture}
\caption{Architecture overview of \spoilsport.}
\label{fig:spoilsport-architecture}
\end{figure}
